<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 6 Model building | Regression and Classification with Tidymodels</title>
<meta name="author" content="Jan Kirenz">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.6.6/header-attrs.js"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.4.9000/tabs.js"></script><script src="libs/bs3compat-0.2.4.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="css/dsbox.css">
<link rel="stylesheet" href="css/fontawesome/css/all.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Regression and Classification with Tidymodels</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li class="book-part">DATA SCIENCE LIFECYCLE</li>
<li><a class="" href="crisp-dm.html"><span class="header-section-number">1</span> CRISP-DM</a></li>
<li class="book-part">REGRESSION</li>
<li><a class="" href="intro.html"><span class="header-section-number">2</span> Introduction</a></li>
<li><a class="" href="business-understanding-1.html"><span class="header-section-number">3</span> Business understanding</a></li>
<li><a class="" href="data-understanding-1.html"><span class="header-section-number">4</span> Data understanding</a></li>
<li><a class="" href="data-preparation-1.html"><span class="header-section-number">5</span> Data preparation</a></li>
<li><a class="active" href="model-building.html"><span class="header-section-number">6</span> Model building</a></li>
<li class="book-part">CLASSIFICATION</li>
<li><a class="" href="intro2.html"><span class="header-section-number">7</span> Introduction</a></li>
<li><a class="" href="business-understanding-2.html"><span class="header-section-number">8</span> Business understanding</a></li>
<li><a class="" href="data-understanding-2.html"><span class="header-section-number">9</span> Data understanding</a></li>
<li><a class="" href="data-preparation-3.html"><span class="header-section-number">10</span> Data preparation</a></li>
<li><a class="" href="model-building-1.html"><span class="header-section-number">11</span> Model building</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/kirenz/tidymodels">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="model-building" class="section level1" number="6">
<h1>
<span class="header-section-number">6</span> Model building<a class="anchor" aria-label="anchor" href="#model-building"><i class="fas fa-link"></i></a>
</h1>
<div id="specify-models" class="section level2" number="6.1">
<h2>
<span class="header-section-number">6.1</span> Specify models<a class="anchor" aria-label="anchor" href="#specify-models"><i class="fas fa-link"></i></a>
</h2>
<p>The process of specifying our models is always as follows:</p>
<ol style="list-style-type: decimal">
<li>Pick a <code>model type</code>
</li>
<li>set the <code>engine</code>
</li>
<li>Set the <code>mode</code>: regression or classification</li>
</ol>
<p>You can choose the <code>model type</code> and <code>engine</code> from this <a href="https://www.tidymodels.org/find/parsnip/">list</a>.</p>
<div id="lasso-regression" class="section level3" number="6.1.1">
<h3>
<span class="header-section-number">6.1.1</span> Lasso regression<a class="anchor" aria-label="anchor" href="#lasso-regression"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">lasso_spec</span> <span class="op">&lt;-</span> <span class="co"># your model specification</span>
  <span class="fu">linear_reg</span><span class="op">(</span>penalty <span class="op">=</span> <span class="fl">0.1</span>, mixture <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># model type and some options</span>
  <span class="fu">set_engine</span><span class="op">(</span>engine <span class="op">=</span> <span class="st">"glmnet"</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># model engine</span>
  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span> <span class="co"># model mode</span>

<span class="co"># Show your model specification</span>
<span class="va">lasso_spec</span>
<span class="co">#&gt; Linear Regression Model Specification (regression)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Main Arguments:</span>
<span class="co">#&gt;   penalty = 0.1</span>
<span class="co">#&gt;   mixture = 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Computational engine: glmnet</span></code></pre></div>
<ul>
<li><p><code>penalty</code>: The total amount of regularization in the model. Higher values imply a higher penalty. If you choose a penalty of 0 you fit a standard linear regression model.</p></li>
<li><p><code>mixture</code>: The mixture amounts of different types of regularization. A number between zero and one (inclusive) that is the proportion of L1 regularization (i.e. lasso) in the model. When mixture = 1, it is a pure lasso model while mixture = 0 indicates that ridge regression is being used (this works only for engines “glmnet” and “spark”).</p></li>
</ul>
<p>Note that for the lasso regression to work properly it is very important to always add a data normalization step.</p>
</div>
<div id="natural-spline" class="section level3" number="6.1.2">
<h3>
<span class="header-section-number">6.1.2</span> Natural spline<a class="anchor" aria-label="anchor" href="#natural-spline"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">spline_spec</span> <span class="op">&lt;-</span> 
  <span class="fu">linear_reg</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>  
  <span class="fu">set_engine</span><span class="op">(</span>engine <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span> <span class="op">%&gt;%</span>  
  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span></code></pre></div>
<p>To use this model correctly, we also need to add a data normalization step as well as a step to declare the degree of freedom in our model. We will include the degrees of freedom at a later step (when we create the workflows).</p>
</div>
<div id="random-forest" class="section level3" number="6.1.3">
<h3>
<span class="header-section-number">6.1.3</span> Random forest<a class="anchor" aria-label="anchor" href="#random-forest"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/imbs-hl/ranger">ranger</a></span><span class="op">)</span>

<span class="va">rf_spec</span> <span class="op">&lt;-</span> 
  <span class="fu">rand_forest</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"ranger"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span></code></pre></div>
</div>
<div id="boosted-tree-xgboost" class="section level3" number="6.1.4">
<h3>
<span class="header-section-number">6.1.4</span> Boosted tree (XGBoost)<a class="anchor" aria-label="anchor" href="#boosted-tree-xgboost"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost">xgboost</a></span><span class="op">)</span>

<span class="va">xgb_spec</span> <span class="op">&lt;-</span> 
  <span class="fu">boost_tree</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"xgboost"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span> </code></pre></div>
</div>
<div id="k-nearest-neighbor" class="section level3" number="6.1.5">
<h3>
<span class="header-section-number">6.1.5</span> K-nearest neighbor<a class="anchor" aria-label="anchor" href="#k-nearest-neighbor"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">knn_spec</span> <span class="op">&lt;-</span> 
  <span class="fu">nearest_neighbor</span><span class="op">(</span>neighbors <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># we can adjust the number of neighbors </span>
  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"kknn"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span> </code></pre></div>
</div>
</div>
<div id="create-workflows" class="section level2" number="6.2">
<h2>
<span class="header-section-number">6.2</span> Create workflows<a class="anchor" aria-label="anchor" href="#create-workflows"><i class="fas fa-link"></i></a>
</h2>
<p>To combine the data preparation recipe with the model building, we use the package <a href="https://workflows.tidymodels.org">workflows</a>. A workflow is an object that can bundle together your pre-processing recipe, modeling, and even post-processing requests (like calculating the RMSE).</p>
<div id="lasso" class="section level3" number="6.2.1">
<h3>
<span class="header-section-number">6.2.1</span> Lasso<a class="anchor" aria-label="anchor" href="#lasso"><i class="fas fa-link"></i></a>
</h3>
<p>Bundle recipe and model with <code>workflows</code>:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">lasso_wflow</span> <span class="op">&lt;-</span> <span class="co"># new workflow object</span>
 <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># use workflow function</span>
 <span class="fu">add_recipe</span><span class="op">(</span><span class="va">housing_rec</span><span class="op">)</span> <span class="op">%&gt;%</span>   <span class="co"># use the new recipe</span>
 <span class="fu">add_model</span><span class="op">(</span><span class="va">lasso_spec</span><span class="op">)</span>   <span class="co"># add your model spec</span></code></pre></div>
</div>
<div id="natural-spline-1" class="section level3" number="6.2.2">
<h3>
<span class="header-section-number">6.2.2</span> Natural spline<a class="anchor" aria-label="anchor" href="#natural-spline-1"><i class="fas fa-link"></i></a>
</h3>
<p>We need to declare the degrees of freedom -with <code>step_ns()</code>- for our natural spline. In our example, we just add the new step to our <code>housing_rec</code> recipe and create a new recipe which we will only use for ourse natural spline.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">splines</span><span class="op">)</span>

<span class="va">housing_rec_spline</span> <span class="op">&lt;-</span> 
  <span class="va">housing_rec</span> <span class="op">%&gt;%</span>  
  <span class="fu">step_ns</span><span class="op">(</span><span class="fu">all_predictors</span><span class="op">(</span><span class="op">)</span>, deg_free <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="co"># natural spline</span></code></pre></div>
<p>The higher the degree of freedom, the more complex the resulting model.</p>
<p>Now we bundle the recipe and our model:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">spline_wflow</span> <span class="op">&lt;-</span> 
 <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
 <span class="fu">add_recipe</span><span class="op">(</span><span class="va">housing_rec_spline</span><span class="op">)</span> <span class="op">%&gt;%</span>   <span class="co"># use the spline recipe</span>
 <span class="fu">add_model</span><span class="op">(</span><span class="va">spline_spec</span><span class="op">)</span> </code></pre></div>
</div>
<div id="random-forest-1" class="section level3" number="6.2.3">
<h3>
<span class="header-section-number">6.2.3</span> Random forest<a class="anchor" aria-label="anchor" href="#random-forest-1"><i class="fas fa-link"></i></a>
</h3>
<p>Bundle recipe and model:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">rf_wflow</span> <span class="op">&lt;-</span>
 <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
 <span class="fu">add_recipe</span><span class="op">(</span><span class="va">housing_rec</span><span class="op">)</span> <span class="op">%&gt;%</span> 
 <span class="fu">add_model</span><span class="op">(</span><span class="va">rf_spec</span><span class="op">)</span> </code></pre></div>
</div>
<div id="xgboost" class="section level3" number="6.2.4">
<h3>
<span class="header-section-number">6.2.4</span> XGBoost<a class="anchor" aria-label="anchor" href="#xgboost"><i class="fas fa-link"></i></a>
</h3>
<p>Bundle recipe and model:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">xgb_wflow</span> <span class="op">&lt;-</span>
 <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
 <span class="fu">add_recipe</span><span class="op">(</span><span class="va">housing_rec</span><span class="op">)</span> <span class="op">%&gt;%</span> 
 <span class="fu">add_model</span><span class="op">(</span><span class="va">xgb_spec</span><span class="op">)</span></code></pre></div>
</div>
<div id="k-nearest-neighbor-1" class="section level3" number="6.2.5">
<h3>
<span class="header-section-number">6.2.5</span> K-nearest neighbor<a class="anchor" aria-label="anchor" href="#k-nearest-neighbor-1"><i class="fas fa-link"></i></a>
</h3>
<p>Bundle recipe and model:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">knn_wflow</span> <span class="op">&lt;-</span>
 <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
 <span class="fu">add_recipe</span><span class="op">(</span><span class="va">housing_rec</span><span class="op">)</span> <span class="op">%&gt;%</span> 
 <span class="fu">add_model</span><span class="op">(</span><span class="va">knn_spec</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="evaluate-models" class="section level2" number="6.3">
<h2>
<span class="header-section-number">6.3</span> Evaluate models<a class="anchor" aria-label="anchor" href="#evaluate-models"><i class="fas fa-link"></i></a>
</h2>
<p>Now we can use our validation set (<code>cv_folds</code>) to estimate the performance of our models using the <code>fit_resamples()</code> function to fit the models on each of the folds and store the results.</p>
<p>Note that <code>fit_resamples()</code> will fit our model to each resample and evaluate on the heldout set from each resample. The function is usually only used for computing performance metrics across some set of resamples to evaluate our models (like RMSE) - the models are not even stored. However, in our example we save the predictions in order to visualize the model fit and residuals with <code>control_resamples(save_pred = TRUE)</code>.</p>
<p>Finally, we collect the performance metrics with <code>collect_metrics()</code> and pick the model that does best on the validation set.</p>
<div id="lasso-regression-1" class="section level3" number="6.3.1">
<h3>
<span class="header-section-number">6.3.1</span> Lasso regression<a class="anchor" aria-label="anchor" href="#lasso-regression-1"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>

<span class="va">lasso_res</span> <span class="op">&lt;-</span> 
  <span class="va">lasso_wflow</span> <span class="op">%&gt;%</span> <span class="co"># use workflow object</span>
  <span class="fu">fit_resamples</span><span class="op">(</span>resamples <span class="op">=</span> <span class="va">cv_folds</span>,
                control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># save predictions</span>
    <span class="op">)</span></code></pre></div>
<p>Show average performance over all folds:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">lasso_res</span> <span class="op">%&gt;%</span>  <span class="fu">collect_metrics</span><span class="op">(</span>summarize <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 x 6</span>
<span class="co">#&gt;   .metric .estimator  mean     n std_err .config             </span>
<span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               </span>
<span class="co">#&gt; 1 rmse    standard   0.357     5 0.00119 Preprocessor1_Model1</span>
<span class="co">#&gt; 2 rsq     standard   0.608     5 0.00356 Preprocessor1_Model1</span></code></pre></div>
<p>Show performance for every single fold:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">lasso_res</span> <span class="op">%&gt;%</span>  <span class="fu">collect_metrics</span><span class="op">(</span>summarize <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 10 x 5</span>
<span class="co">#&gt;   id    .metric .estimator .estimate .config             </span>
<span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               </span>
<span class="co">#&gt; 1 Fold1 rmse    standard       0.356 Preprocessor1_Model1</span>
<span class="co">#&gt; 2 Fold1 rsq     standard       0.599 Preprocessor1_Model1</span>
<span class="co">#&gt; 3 Fold2 rmse    standard       0.354 Preprocessor1_Model1</span>
<span class="co">#&gt; 4 Fold2 rsq     standard       0.613 Preprocessor1_Model1</span>
<span class="co">#&gt; 5 Fold3 rmse    standard       0.361 Preprocessor1_Model1</span>
<span class="co">#&gt; 6 Fold3 rsq     standard       0.608 Preprocessor1_Model1</span>
<span class="co">#&gt; # … with 4 more rows</span></code></pre></div>
<p>To assess the model predictions, we plot the predictions on the y-axis and the real median house value at the x-axis. Note that the red line is not our model. If our model would have made no mistakes at all, all points would lie on the red diagonal line (where the prediction equals the real value).</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">assess_res</span> <span class="op">&lt;-</span> <span class="fu">collect_predictions</span><span class="op">(</span><span class="va">lasso_res</span><span class="op">)</span>

<span class="va">assess_res</span> <span class="op">%&gt;%</span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">median_house_value</span>, y <span class="op">=</span> <span class="va">.pred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_point</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.15</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_abline</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">coord_obs_pred</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Predicted"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="Tidymodels_files/figure-html/unnamed-chunk-50-1.png" width="100%" height="100%" style="display: block; margin: auto;"></div>
<p>Let`s look at the 10 districts where our model produced the greatest residuals:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">wrongest_prediction</span> <span class="op">&lt;-</span> 
  <span class="va">assess_res</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>residual <span class="op">=</span> <span class="va">median_house_value</span> <span class="op">-</span> <span class="va">.pred</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">residual</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">slice_head</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>

<span class="va">wrongest_prediction</span>
<span class="co">#&gt; # A tibble: 10 x 6</span>
<span class="co">#&gt;   id    .pred  .row median_house_value .config              residual</span>
<span class="co">#&gt;   &lt;chr&gt; &lt;dbl&gt; &lt;int&gt;              &lt;dbl&gt; &lt;chr&gt;                   &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Fold1  11.9  6523               9.62 Preprocessor1_Model1    -2.30</span>
<span class="co">#&gt; 2 Fold3  12.0  4197               9.77 Preprocessor1_Model1    -2.21</span>
<span class="co">#&gt; 3 Fold3  12.0  1348              10.0  Preprocessor1_Model1    -2.01</span>
<span class="co">#&gt; 4 Fold5  11.6  2084               9.62 Preprocessor1_Model1    -1.98</span>
<span class="co">#&gt; 5 Fold5  11.5  1868               9.62 Preprocessor1_Model1    -1.87</span>
<span class="co">#&gt; 6 Fold1  12.0 12383              10.3  Preprocessor1_Model1    -1.79</span>
<span class="co">#&gt; # … with 4 more rows</span></code></pre></div>
<p>Show the observations in the training data.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">train_data</span> <span class="op">%&gt;%</span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">wrongest_prediction</span><span class="op">$</span><span class="va">.row</span><span class="op">)</span> 
<span class="co">#&gt; # A tibble: 10 x 8</span>
<span class="co">#&gt;   longitude latitude median_house_va… median_income ocean_proximity</span>
<span class="co">#&gt;       &lt;dbl&gt;    &lt;dbl&gt;            &lt;dbl&gt;         &lt;dbl&gt; &lt;fct&gt;          </span>
<span class="co">#&gt; 1     -118.     34.2            14999          4.19 INLAND         </span>
<span class="co">#&gt; 2     -118.     34.2            17500          2.37 &lt;1H OCEAN      </span>
<span class="co">#&gt; 3     -122.     37.9            22500          2.68 NEAR BAY       </span>
<span class="co">#&gt; 4     -117.     36.4            14999          2.1  INLAND         </span>
<span class="co">#&gt; 5     -123.     39.7            14999          1.66 INLAND         </span>
<span class="co">#&gt; 6     -121.     34.7            28300          2.74 NEAR OCEAN     </span>
<span class="co">#&gt; # … with 4 more rows, and 3 more variables: bedrooms_per_room &lt;dbl&gt;,</span>
<span class="co">#&gt; #   rooms_per_household &lt;dbl&gt;, population_per_household &lt;dbl&gt;</span></code></pre></div>
<p>In this tutorial, we don’t further investigate the reasons for the wrong predictions. In reality, we would check wether some of the districts are outliers in comparision to the rest of our data and we would need to decide if we should drop some of the cases from the data (if there are good reasons to do so).</p>
</div>
<div id="natural-spline-2" class="section level3" number="6.3.2">
<h3>
<span class="header-section-number">6.3.2</span> Natural spline<a class="anchor" aria-label="anchor" href="#natural-spline-2"><i class="fas fa-link"></i></a>
</h3>
<p>We don’t repeat all of the steps shown in lasso regression and just focus on the performance metrics.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">spline_res</span> <span class="op">&lt;-</span>
  <span class="va">spline_wflow</span> <span class="op">%&gt;%</span> 
  <span class="fu">fit_resamples</span><span class="op">(</span>
    resamples <span class="op">=</span> <span class="va">cv_folds</span>,
    control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="op">)</span>

<span class="va">spline_res</span> <span class="op">%&gt;%</span>  <span class="fu">collect_metrics</span><span class="op">(</span>summarize <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 x 6</span>
<span class="co">#&gt;   .metric .estimator  mean     n std_err .config             </span>
<span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               </span>
<span class="co">#&gt; 1 rmse    standard   0.308     4 0.00101 Preprocessor1_Model1</span>
<span class="co">#&gt; 2 rsq     standard   0.665     4 0.00199 Preprocessor1_Model1</span></code></pre></div>
</div>
<div id="random-forest-2" class="section level3" number="6.3.3">
<h3>
<span class="header-section-number">6.3.3</span> Random forest<a class="anchor" aria-label="anchor" href="#random-forest-2"><i class="fas fa-link"></i></a>
</h3>
<p>We don’t repeat all of the steps shown in lasso regression and just focus on the performance metrics.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">rf_res</span> <span class="op">&lt;-</span>
  <span class="va">rf_wflow</span> <span class="op">%&gt;%</span> 
  <span class="fu">fit_resamples</span><span class="op">(</span>
    resamples <span class="op">=</span> <span class="va">cv_folds</span>,
    control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="op">)</span>

<span class="va">rf_res</span> <span class="op">%&gt;%</span>  <span class="fu">collect_metrics</span><span class="op">(</span>summarize <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 x 6</span>
<span class="co">#&gt;   .metric .estimator  mean     n std_err .config             </span>
<span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               </span>
<span class="co">#&gt; 1 rmse    standard   0.309     5 0.00135 Preprocessor1_Model1</span>
<span class="co">#&gt; 2 rsq     standard   0.673     5 0.00144 Preprocessor1_Model1</span></code></pre></div>
</div>
<div id="xgboost-1" class="section level3" number="6.3.4">
<h3>
<span class="header-section-number">6.3.4</span> XGBoost<a class="anchor" aria-label="anchor" href="#xgboost-1"><i class="fas fa-link"></i></a>
</h3>
<p>We don’t repeat all of the steps shown in lasso regression and just focus on the performance metrics.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">xgb_res</span> <span class="op">&lt;-</span> 
  <span class="va">xgb_wflow</span> <span class="op">%&gt;%</span> 
  <span class="fu">fit_resamples</span><span class="op">(</span>
    resamples <span class="op">=</span> <span class="va">cv_folds</span>,
    control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="op">)</span> 

<span class="va">xgb_res</span> <span class="op">%&gt;%</span> <span class="fu">collect_metrics</span><span class="op">(</span>summarize <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 x 6</span>
<span class="co">#&gt;   .metric .estimator  mean     n std_err .config             </span>
<span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               </span>
<span class="co">#&gt; 1 rmse    standard   0.304     5 0.00158 Preprocessor1_Model1</span>
<span class="co">#&gt; 2 rsq     standard   0.685     5 0.00102 Preprocessor1_Model1</span></code></pre></div>
</div>
<div id="k-nearest-neighbor-2" class="section level3" number="6.3.5">
<h3>
<span class="header-section-number">6.3.5</span> K-nearest neighbor<a class="anchor" aria-label="anchor" href="#k-nearest-neighbor-2"><i class="fas fa-link"></i></a>
</h3>
<p>We don’t repeat all of the steps shown in lasso regression and just focus on the performance metrics.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">knn_res</span> <span class="op">&lt;-</span> 
  <span class="va">knn_wflow</span> <span class="op">%&gt;%</span> 
  <span class="fu">fit_resamples</span><span class="op">(</span>
    resamples <span class="op">=</span> <span class="va">cv_folds</span>,
    control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="op">)</span> 

<span class="va">knn_res</span> <span class="op">%&gt;%</span> <span class="fu">collect_metrics</span><span class="op">(</span>summarize <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 x 6</span>
<span class="co">#&gt;   .metric .estimator  mean     n std_err .config             </span>
<span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               </span>
<span class="co">#&gt; 1 rmse    standard   0.338     5 0.00136 Preprocessor1_Model1</span>
<span class="co">#&gt; 2 rsq     standard   0.611     5 0.00184 Preprocessor1_Model1</span></code></pre></div>
</div>
<div id="compare-models" class="section level3" number="6.3.6">
<h3>
<span class="header-section-number">6.3.6</span> Compare models<a class="anchor" aria-label="anchor" href="#compare-models"><i class="fas fa-link"></i></a>
</h3>
<p>Extract the RMSE from our models to compare them:</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">lasso_rmse</span> <span class="op">&lt;-</span> 
  <span class="va">lasso_res</span> <span class="op">%&gt;%</span> 
  <span class="fu">collect_metrics</span><span class="op">(</span>summarise <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>model <span class="op">=</span> <span class="st">"lasso"</span><span class="op">)</span>

<span class="va">spline_rmse</span> <span class="op">&lt;-</span> 
  <span class="va">spline_res</span> <span class="op">%&gt;%</span> 
  <span class="fu">collect_metrics</span><span class="op">(</span>summarise <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>model <span class="op">=</span> <span class="st">"spline"</span><span class="op">)</span>

<span class="va">rf_rmse</span> <span class="op">&lt;-</span> 
  <span class="va">rf_res</span> <span class="op">%&gt;%</span> 
  <span class="fu">collect_metrics</span><span class="op">(</span>summarise <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>model <span class="op">=</span> <span class="st">"random forest"</span><span class="op">)</span>

<span class="va">xgb_rmse</span> <span class="op">&lt;-</span> 
  <span class="va">xgb_res</span> <span class="op">%&gt;%</span> 
  <span class="fu">collect_metrics</span><span class="op">(</span>summarise <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>model <span class="op">=</span> <span class="st">"XGBoost"</span><span class="op">)</span>

<span class="va">knn_rmse</span> <span class="op">&lt;-</span> 
  <span class="va">knn_res</span> <span class="op">%&gt;%</span> 
  <span class="fu">collect_metrics</span><span class="op">(</span>summarise <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>model <span class="op">=</span> <span class="st">"Knn"</span><span class="op">)</span>

<span class="co"># create dataframe with all models</span>
<span class="va">model_compare</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">lasso_rmse</span>,
                           <span class="va">spline_rmse</span>,
                           <span class="va">rf_rmse</span>,
                           <span class="va">xgb_rmse</span>,
                           <span class="va">knn_rmse</span><span class="op">)</span> 

<span class="co"># change data structure</span>
<span class="va">model_comp</span> <span class="op">&lt;-</span> 
  <span class="va">model_compare</span> <span class="op">%&gt;%</span> 
  <span class="fu">select</span><span class="op">(</span><span class="va">model</span>, <span class="va">.metric</span>, <span class="va">mean</span>, <span class="va">std_err</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">.metric</span>, values_from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mean</span>, <span class="va">std_err</span><span class="op">)</span><span class="op">)</span> 

<span class="co"># show rmse </span>
<span class="va">model_comp</span> <span class="op">%&gt;%</span> 
  <span class="fu">arrange</span><span class="op">(</span><span class="va">mean_rmse</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>model <span class="op">=</span> <span class="fu">fct_reorder</span><span class="op">(</span><span class="va">model</span>, <span class="va">mean_rmse</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">model</span>, <span class="va">mean_rmse</span>, fill<span class="op">=</span><span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_col</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_fill_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Blues"</span><span class="op">)</span>

<span class="co"># show rsq </span>
<span class="va">model_comp</span> <span class="op">%&gt;%</span> 
  <span class="fu">arrange</span><span class="op">(</span><span class="va">mean_rsq</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>model <span class="op">=</span> <span class="fu">fct_reorder</span><span class="op">(</span><span class="va">model</span>, <span class="fu">desc</span><span class="op">(</span><span class="va">mean_rsq</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">model</span>, <span class="va">mean_rsq</span>, fill<span class="op">=</span><span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_col</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_fill_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Blues"</span><span class="op">)</span>
  </code></pre></div>
<p><img src="Tidymodels_files/figure-html/unnamed-chunk-57-1.png" width="100%" height="100%" style="display: block; margin: auto;"><img src="Tidymodels_files/figure-html/unnamed-chunk-57-2.png" width="100%" height="100%" style="display: block; margin: auto;"></p>
<p>Note that the model results are quite similar.</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># find minimum rmse</span>
<span class="va">model_comp</span> <span class="op">%&gt;%</span> 
  <span class="fu">slice_min</span><span class="op">(</span><span class="va">mean_rmse</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 x 5</span>
<span class="co">#&gt;   model   mean_rmse mean_rsq std_err_rmse std_err_rsq</span>
<span class="co">#&gt;   &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;</span>
<span class="co">#&gt; 1 XGBoost     0.304    0.685      0.00158     0.00102</span></code></pre></div>
<p>Now it’s time to fit the best model (in our case the XGBoost model) one last time to the full <em>training set</em> and evaluate the resulting final model on the <em>test set</em>.</p>
</div>
</div>
<div id="last-fit-and-evaluation-on-test-set" class="section level2" number="6.4">
<h2>
<span class="header-section-number">6.4</span> Last fit and evaluation on test set<a class="anchor" aria-label="anchor" href="#last-fit-and-evaluation-on-test-set"><i class="fas fa-link"></i></a>
</h2>
<p>Tidymodels provides the function <a href="https://tune.tidymodels.org/reference/last_fit.html"><code>last_fit()</code></a> which fits a model to the <em>training data</em> and evaluates it on the <em>test set</em>. We just need to provide the workflow object of the best model as well as the <strong>data split</strong> object (not the training data).</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">last_fit_xgb</span> <span class="op">&lt;-</span> <span class="fu">last_fit</span><span class="op">(</span><span class="va">xgb_wflow</span>, split <span class="op">=</span> <span class="va">data_split</span><span class="op">)</span>

<span class="co"># Show RMSE and RSQ</span>
<span class="va">last_fit_xgb</span> <span class="op">%&gt;%</span> 
  <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 x 4</span>
<span class="co">#&gt;   .metric .estimator .estimate .config             </span>
<span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               </span>
<span class="co">#&gt; 1 rmse    standard       0.305 Preprocessor1_Model1</span>
<span class="co">#&gt; 2 rsq     standard       0.682 Preprocessor1_Model1</span></code></pre></div>
<p>And this is our final result. Remember that if a model fit to the training dataset also fits the test dataset well, minimal <em>overfitting</em> has taken place. This seems to be also the case in our example.</p>

</div>
</div>



  <div class="chapter-nav">
<div class="prev"><a href="data-preparation-1.html"><span class="header-section-number">5</span> Data preparation</a></div>
<div class="next"><a href="intro2.html"><span class="header-section-number">7</span> Introduction</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#model-building"><span class="header-section-number">6</span> Model building</a></li>
<li>
<a class="nav-link" href="#specify-models"><span class="header-section-number">6.1</span> Specify models</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#lasso-regression"><span class="header-section-number">6.1.1</span> Lasso regression</a></li>
<li><a class="nav-link" href="#natural-spline"><span class="header-section-number">6.1.2</span> Natural spline</a></li>
<li><a class="nav-link" href="#random-forest"><span class="header-section-number">6.1.3</span> Random forest</a></li>
<li><a class="nav-link" href="#boosted-tree-xgboost"><span class="header-section-number">6.1.4</span> Boosted tree (XGBoost)</a></li>
<li><a class="nav-link" href="#k-nearest-neighbor"><span class="header-section-number">6.1.5</span> K-nearest neighbor</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#create-workflows"><span class="header-section-number">6.2</span> Create workflows</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#lasso"><span class="header-section-number">6.2.1</span> Lasso</a></li>
<li><a class="nav-link" href="#natural-spline-1"><span class="header-section-number">6.2.2</span> Natural spline</a></li>
<li><a class="nav-link" href="#random-forest-1"><span class="header-section-number">6.2.3</span> Random forest</a></li>
<li><a class="nav-link" href="#xgboost"><span class="header-section-number">6.2.4</span> XGBoost</a></li>
<li><a class="nav-link" href="#k-nearest-neighbor-1"><span class="header-section-number">6.2.5</span> K-nearest neighbor</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#evaluate-models"><span class="header-section-number">6.3</span> Evaluate models</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#lasso-regression-1"><span class="header-section-number">6.3.1</span> Lasso regression</a></li>
<li><a class="nav-link" href="#natural-spline-2"><span class="header-section-number">6.3.2</span> Natural spline</a></li>
<li><a class="nav-link" href="#random-forest-2"><span class="header-section-number">6.3.3</span> Random forest</a></li>
<li><a class="nav-link" href="#xgboost-1"><span class="header-section-number">6.3.4</span> XGBoost</a></li>
<li><a class="nav-link" href="#k-nearest-neighbor-2"><span class="header-section-number">6.3.5</span> K-nearest neighbor</a></li>
<li><a class="nav-link" href="#compare-models"><span class="header-section-number">6.3.6</span> Compare models</a></li>
</ul>
</li>
<li><a class="nav-link" href="#last-fit-and-evaluation-on-test-set"><span class="header-section-number">6.4</span> Last fit and evaluation on test set</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/kirenz/tidymodels/blob/master/02-regression.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/kirenz/tidymodels/edit/master/02-regression.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Regression and Classification with Tidymodels</strong>" was written by Jan Kirenz. It was last built on 2021-02-11.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
